<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="productMapper">

	<!-- 
		PRODUCT_ID, NAME, PRICE, STOCK, DESCRIPTION, CREATED_AT, MEMBER_ID, COUNTRY_ID
	 -->

	<!-- 상품 목록 조회 -->
	<resultMap type="Product" id="productListResultMap">
		<result column="PRODUCT_ID" property="productId" />
		<result column="NAME" property="name" />
		<result column="PRICE" property="price" />
	</resultMap>
	<select id="selectProductList" resultMap="productListResultMap" parameterType="Product">
		SELECT PRODUCT_ID, NAME, PRICE
		FROM TB_PRODUCT
		ORDER BY CREATED_AT DESC
	</select>
	
	<!-- 상품아이디로 상품 조회 -->
	<resultMap type="Product" id="productByProductId">
		<result column="PRODUCT_ID" property="productId" />
		<result column="NAME" property="name" />
		<result column="PRICE" property="price" />
		<result column="STOCK" property="stock" />
		<result column="DESCRIPTION" property="description" />
		<result column="CREATED_AT" property="createdAt" />
		<result column="MEMBER_ID" property="memberId" />
		<result column="COUNTRY_ID" property="countryId" />
	</resultMap>
	<select id="selectProductByProductId" resultMap="productByProductId" parameterType="Product">
		SELECT *
		FROM TB_PRODUCT
		WHERE PRODUCT_ID = #{productId}
	</select>
	
	<!-- 상품의 전체 갯수 조회 -->
	<!-- 
	<select id="selectByProductNameCount" resultType="_int">
		SELECT COUNT(*) FROM TB_PRODUCT
		WHERE 1=1
			<if test="sort == 'recentValue'">
				AND NAME LIKE '%${keyword}%'
			</if>
			<if test="sort == 'reviewValue'">
				AND NAME LIKE '%${keyword}%'
			</if>
			<if test="sort == 'priceValue'">
				AND NAME LIKE '%${keyword}%'
			</if>
	</select>
	 -->
	<select id="selectByProductNameCount" resultType="_int">
		SELECT COUNT(*) FROM TB_PRODUCT
		WHERE 1=1
		<if test="sort == 'recentValue' or sort == 'reviewValue' or sort == 'priceValue'">
			AND NAME LIKE '%${keyword}%'
		</if>
	</select>
		
	
	<!-- 상품의 전체 데이터 조회(키워드가 있을 검색 포함) -->
	<resultMap type="kr.co.khedu.product.model.dto.ProductListDTO" id="productListKeywordResultMap">
		<result column="PRODUCT_ID" property="productId" />
	</resultMap>
	<select id="findByProductNameLike" resultMap="productListKeywordResultMap">
		SELECT 
		    PRODUCT_ID,
		    NAME,
		    PRICE,
		    CREATED_AT,
		    ROUND(NVL(AVG(SCORE), 0), 1) AS SCORE
		FROM TB_PRODUCT
			LEFT JOIN TB_PRODUCT_REVIEW USING(PRODUCT_ID)
		WHERE 1 = 1 AND NAME LIKE '%${keyword}%'
		GROUP BY PRODUCT_ID, NAME, PRICE, CREATED_AT
		<if test="sort == 'recentValue'">
			ORDER BY CREATED_AT DESC
		</if>
		<if test="sort == 'reviewValue'">
			ORDER BY SCORE DESC, CREATED_AT DESC
		</if>
		<if test="sort == 'priceValue'">
			ORDER BY PRICE DESC, CREATED_AT DESC
		</if>
	</select>
</mapper>